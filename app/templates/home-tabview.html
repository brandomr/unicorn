{% extends "base.html.part" %}
{% block title %}Search{% endblock %}
{% block styles %}
{{ super() }}
.form-search{
    margin: auto;
}
.search-query {
    width:50%;
}

.search-holder {
  text-align: center;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}
g.node:not(:hover) g.nodetext {
    display:none;
}

#viz-container {
}

#viz-container text {
    font: 10px sans-serif;
    pointer-events: none;
}

.nav a{
color:rgb(50,88,50);
}

.nav active a {
color:"blue";
}

    body {
        font-family:"Lucida Grande","Droid Sans",Arial,Helvetica,sans-serif;
    }
    .legend {
        border: 1px solid #555555;
        border-radius: 5px 5px 5px 5px;
        font-size: 0.8em;
        margin: 10px;
        padding: 8px;
    }
    .bld {
        font-weight: bold;
    }

{% endblock %}

{% block content %}
<div class="container">
<div class="search-holder">
<form class="form-search">
<input type="text" class="span2 search-query" id="search">
    <button type="submit" class="btn btn-primary btn-lg" id="submit_search"><i class="fa fa-search"></i></button>
    <button type="button" 
     class="btn" data-toggle="modal" data-target="#viz-modal" 
      id="submit_net" data-controls="network"><i class="fa fa-eye-slash"></i></button>
      <button type="button" 
     class="btn" data-toggle="modal" data-target="#viz-modal" 
      id="submit_wc" data-controls="wordcloud"><i class="fa fa-cloud"></i></button>
</form>
</div>

<div class="search-results">
<table class="table table-striped">
  <thead>
    <tr>
      <th>#</th>
      <th>File</th>
      <th>Snippet</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>

<div id="viz-modal" class="modal fade" tabindex="-1" role="dialog" 
  aria-labelledby="network-title" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="network-title">Entity Network</h4><img src={{url_for('static', filename="unicorn.png")}} height="35">
      </div>
      <div class="modal-body"> 
        <div id="viz-container">
        </div>
      </div>
    </div>
  </div>
</div>

</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript">

$(function () {
    $('#search-navbar-item').attr('class', 'active');

    $("#submit_search").click(function(e){
      console.log($("#search").val());
      loader($("#search").val());
      e.preventDefault();
    });
    
    /* Event handlers for visualizations to appear */
      $("#viz-modal").on('shown.bs.modal', function (e) {
        var search_term = $("#search").val(),
          button = $(e.relatedTarget);

        console.log(search_term);

        if ( button.data('controls') == 'network') {
          network_loader(search_term);
        }
        else if ( button.data('controls') == 'wordcloud') {
          wc_loader(search_term);
        }
    });
})


function network_loader(query){
  $("#viz-container").html('');
  $.get('viz/'+query,function(data){
    
 
    graph=JSON.parse(data);
    console.log(graph);
    var network_container = $("#viz-container");
    var width = network_container.parent().width(),
        height = width;

      var color = d3.scale.category20();

      
      var svg = d3.select("#viz-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("pointer-events","all")
        .append('svg:g')
        .call(d3.behavior.zoom().on("zoom",redraw))
        .append('svg:g');

       var force = d3.layout.force()
          .nodes(graph.nodes)
          .links(graph.links)
          .size([width, height])
          .linkDistance(100)
          .charge(-200)
          .start();

        function redraw(){
          svg.attr("transform","translate("
          + d3.event.translate+")"+" scale("+d3.event.scale+")");
        }

        var link = svg.append("g").selectAll(".link")
            .data(graph.links)
          .enter().append("line")
            .attr("class", "link");

      // Create the groups under svg
      var gnodes = svg.selectAll('g.gnode')
        .data(graph.nodes)
        .enter()
        .append('g')
        .classed('gnode', true);

      // Add one circle in each group
      var node = gnodes.append("circle")
        .attr("class", "node")
        .attr("r", 5)
        .attr("fill","cadetblue")
        .on("click",function(d){
          window.open("/view/"+d.origin)
        })
        .call(force.drag);

      var labels = gnodes.append("text")
        .attr("fill","black")
        .text(function(d) { return d.id; });

      force.on("tick", function() {
        // Update the links
        link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

        // Translate the groups
        gnodes.attr("transform", function(d) { 
          return 'translate(' + [d.x, d.y] + ')'; 
        });    

      });
});
}


function loader(query){
  $.get('search/'+query,function(data){
      var tbl_row="";
      var tbl_body="";
      var tbl_elem = $('.search-results > table > tbody');
      tbl_elem.html('');
      list=data['result'];
      
      for(var row=0; row<list.length; row++){
        var row_elem = $('<tr>');

        var i_elem = $('<th scope="row">').text(row + 1);
        row_elem.append(i_elem);
        
        var doc_id = list[row][0];
        for (var col=1; col<list[row].length; col++) {
          var col_elem = $('<td>').html(list[row][col]);
          if ( col == 1 ) {
            col_elem.wrapInner("<a href=/download/" + doc_id + "></a>");
          }
          else if ( col == 2 ) {
            col_elem.wrapInner("<a href=/view/" + doc_id + "></a>");
          }
          row_elem.append(col_elem);
        }
        tbl_elem.append(row_elem);
      }

      //tbl_selector.append(tbl_body)
      //$("#myTable").DataTable();
      });
}

function wc_loader(query){
  $("#viz-container").html('');
  $.get('wordcloud/'+query, function(data){
  frequency_list=JSON.parse(data)
  var color = d3.scale.linear()
            .domain([0,1,2,3,4,5,6,10,15,20,100])
            .range(["#ddd", "#ccc", "#bbb", "#aaa", "#999", "#888", "#777", "#666", "#555", "#444", "#333", "#222"]);
    
    var network_container = $("#viz-container");
    var container_width = network_container.parent().outerWidth(),
        width = network_container.parent().innerWidth()
        height = width;

    d3.layout.cloud().size([width*3/4, height*3/4])
            .words(frequency_list)
            .rotate(0)
            .fontSize(function(d) { return d.size; })
            .on("end", draw)
            .start();

    function draw(words) {
        d3.select("#viz-container").append("svg")
                .attr("width", container_width)
                .attr("height", height)
                .attr("class", "wordcloud")
                .append("g")
                // without the transform, words words would get cutoff to the left and top, they would
                // appear outside of the SVG area
                .attr("transform", "translate(" + width/2 + "," + height/2 + ")")
                .selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function(d) { return d.size + "px"; })
                .style("fill", function(d, i) { return color(i); })
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) { return d.text; });
    }

});

}
//loader('dagoberto');
                                                
</script>
                                                
{% endblock %}

